#!/usr/bin/env bash
# Core update logic — fetched and run by AGENTS.sh
# Usage: update <target_dir>
set -euo pipefail

TARGET_DIR="${1:?Usage: update <target_dir>}"
POLICY_REPO_URL="git@github.com:thecleanbedroom/dotai.git"
REFERENCE="main"

command -v git >/dev/null 2>&1 || { echo "Error: git not found." >&2; exit 1; }
command -v rsync >/dev/null 2>&1 || { echo "Error: rsync not found." >&2; exit 1; }

cat <<INFO
This script will clone the dotai policy repository and sync rules/config into:
  $TARGET_DIR

Existing policy files may be overwritten (except PROJECT.md and Git folders).
Local-only files will be preserved. Review the diff after it completes.

To install skills, run the /add-skills workflow after syncing.
INFO

read -rp "Proceed with sync? [y/N] " confirm
if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 0
fi

temp_dir="$(mktemp -d)"
trap 'rm -rf "$temp_dir"' EXIT

printf 'Fetching policy repo %s (%s)\n' "$POLICY_REPO_URL" "$REFERENCE"
git clone --depth 1 --branch "$REFERENCE" "$POLICY_REPO_URL" "$temp_dir/policy" >/dev/null 2>&1 || {
    echo "Error: git clone of policy repo failed" >&2
    exit 1
}

printf 'Syncing policy files to %s\n' "$TARGET_DIR"

# Sync only the directories and files we own — never touch project-local files
SYNC_DIRS=".agent .codex .continue .cursor .gemini .github .windsurf"
for dir in $SYNC_DIRS; do
    if [ -d "$temp_dir/policy/$dir" ]; then
        mkdir -p "$TARGET_DIR/$dir"
        rsync -av \
            --exclude '.agent/skills' \
            --exclude '.agent/dotai' \
            "$temp_dir/policy/$dir/" "$TARGET_DIR/$dir/"
    fi
done

# Sync root-level files we own
for file in AGENTS.sh AGENTS.md; do
    if [ -f "$temp_dir/policy/$file" ]; then
        cp "$temp_dir/policy/$file" "$TARGET_DIR/$file"
        printf '  %s\n' "$file"
    fi
done

echo 'Policy files synchronized. Review changes and commit as needed.'
echo 'Run /add-skills to install project-specific skills.'
